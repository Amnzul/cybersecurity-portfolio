<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Project: What does my ISP see? Analyzing Packets. Scenario 4: HTTPS + DoH </title>
  <link rel="stylesheet" href="../../../styles.css"/>
  <style>
    /* Override: Remove canvas/matrix rain for this page */
    #matrix-rain { display: none !important; }
    body {
      background: #000 !important;
    }
  </style>
</head>
<body>
  <header>
    <h1>Mr. W. - Project: What does my ISP see? Analyzing Packets. Scenario 4: HTTPS + DoH.</h1>
    <nav>
      <a href="../../../index.html">Portfolio Home</a>
    </nav>
  </header>

<section id="analyzing_packets">

<h2> Project: What does my ISP see? Analyzing Packets. Scenario 4: HTTPS + DoH.</h2>
<p></p>

<h2>Scenario 4: HTTPS + DoH. Breakdown:</h2>
<p></p>
<h2>Overview</h2>
<p></p>
<p>DoH is DNS over HTTPS. DoH encrypts DNS queries by sending them over HTTPS, enhancing privacy and security by preventing eavesdropping and manipulation of DNS data.</p>
<p>DoH will encrypt your DNS requests so lets see what that looks like, and what is able to be seen from a packet capture.</p>
<p></p>
<h2>Setup</h2>
<p>I set up a new virtual machine with Linux Ubuntu installed and Firefox in previous scenarios. I am continuing to use the same operating system.</p>
<p>This time I have made some changes to the Firefox settings to require DoH.</p>
<p>Here I have enabled HTTPS-Only Mode.</p>

<img src="firefoxhttpsonly.png">

<p>Here DNS over HTTPS is set to always use secure DNS.</p>

<img src="firefoxdohonly.png">

<p>I will again look to capture packets from the same Ubuntu host that is browsing to see what exits the local host, and again on the OPNSense firewall between my router and the ISP ONT to see what exits my home network. I will also examine the Zenarmor NexGen Firewall Plugin live logs to watch for connections being made and traffic.</p>
<p>I hope to see only encrypted traffic in this scenario.</p>
<p></p>
<p></p>
<hr>
<h2>Activity on the local host:</h2>
<p>The website used will be <a href="https://duckduckgo.com/">https://duckduckgo.com/</a>. I set all devices to capture traffic, then load the webpage.</p>

<div style="text-align: center;">
  <img src="scenario4httpsdohurl.png" style="width: 50%; display: block; margin: 0 auto;">
</div>

<p></p>
<p>I capture all traffic using tcpdump and write it out to a file.</p>
<pre><code>sudo tcpdump -w scenario4httpsdohubuntu.pcap</code></pre>
<p></p>
<p>Reading the packet capture file and filtering for port 53 shows all the DNS queries. Duckduckgo is not in the list of requests so this must be encrypted and not able to be deciphered. Cloudflare DNS is shown here which is the provider selected in the Firefox DNS over HTTPS settings.</p>

<img src="scenario4httpsdohubuntutcpdumpport53.png">

<p>There were no visible ‘GET’ commands and Duckduckgo did not appear anywhere in the packet capture. Even the domain name is hidden when using DoH.</p>

<img src="scenario4httpsdohubuntutcpdumpcloudflare.png">

<p>Traffic must still flow from the duckduckgo server though. So resolving the <a href="http://www.duckduckgo.com" rel="nofollow">http://www.duckduckgo.com</a> address using the dig command shows the IP address.</p>

<img src="scenario4httpsdohdigduckduckgo.png">

<p>Armed with this information we can see there was indeed traffic from Duckduckgo’s IP address to the computer.</p>
<pre><code>tcpdump -r scenario4httpsdohubuntu.pcap host 52.149.246.39</code></pre>

<img src="scenario4httpsdohubuntutcpdumpduckduckgoiptraffic.png">

<p>This required a few more steps, but an ISP would still be able to see where traffic is coming from even though the DNS requests are encrypted. Unencrypted DNS queries just make it easy for eavesdroppers.</p>

<p></p>
<hr>
<h2>On the firewall beyond the router:</h2>
<p>Inspecting the firewall’s live logs showed no DNS requests for Duckduckgo. This makes sense since they are encrypted.</p>

<img src="scenario4httpsdohOPNzenarmordnsduckduckgo.png">

<p>The firewall did see the same cloudflare DNS traffic as the Ubuntu workstation.</p>

<img src="scenario4httpsdohOPNzenarmordnscloudflare.png">

<p>In the TLS tab of the live logs the firewall does show traffic to Duckduckgo. </p>

<img src="scenario4httpsdohOPNzenarmortls.png">

<p>I am assuming the firewall is doing automatic lookups to the IP address to show this information.</p>
<p></p>
<p>I loaded the packet capture from this firewall into Wireshark for further analysis.</p>
<p>Wireshark is filtering out port 53 to view DNS queries. Seen in here is the DNS request for cloudflare but no mention of Duckduckgo itself.</p>

<img src="scenario4httpsdohOPNwiresharkdns.png">

<p>Wireshark filtering for Duckduckgo only gives us encrypted traffic.</p>

<img src="scenario4httpsdohOPNwiresharkfilterduckduckgo.png">

<p>Wireshark filtering for the Duckduckgo IP address we found previous shows encrypted traffic but nothing is able to be made out in terms of content.</p>

<img src="scenario4httpsdohOPNwiresharkfilterduckduckgoip.png">

<p></p>
<p></p>
<p>This is the last hop where I can capture packets. This is the same data that is being seen outside my home network. </p>
<p></p>
<p></p>
<hr>
<h2>Conclusion:</h2>
<p>Webpage content is hidden, as are the requests to resolve a web server into its IP address.</p>
<p>DoH encrypts the DNS queries, but your computer still is communicating with the IP address of a remote server, which can be looked up.</p>
<p>Encrypting DNS queries is gaining momentum and becoming the norm in our world of ever increased risk and security.</p>
<p>Anyone intercepting traffic can still see source and destination IP addresses.</p>
<p>This is the equivalent of sending an encoded letter through the mail. If someone opens your letter they cant read it, but the postman still needs to know where to deliver the mail.</p>

  
  
<p>That’s it!</p>
<p></p>
<p></p>
<p></p>
    
</section>

</body>
</html>
